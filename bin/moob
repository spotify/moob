#!/usr/bin/env ruby

require 'optparse'
require 'moob'

options = {
    :action => :jnlp,
    :type => :auto,
    :machines => []
}

OptionParser.new do |opts|
    opts.on '-l', '--list',
    'List LOM types' do
        Moob::TYPES.each do |sym, klass|
            puts "#{sym} (#{klass.name})"
        end
        exit 0
    end

    opts.on '-t', '--type t',
    'LOM type, or \'auto\' for autodetection',
    'Defaults to auto' do |t|
            options[:type] = t.to_sym
    end

    opts.on '-u', '--username u',
    'LOM username',
    'Defaults to the model\'s default if known' do |u|
            options[:username] = u
    end

    opts.on '-p', '--password p',
    'LOM password',
    'Defaults to the model\'s default if known' do |p|
            options[:password] = p
    end

    opts.on '-m', '--machines a,b,c', Array,
    'Comma-separated list of LOM hostnames' do |m|
            options[:machines] = m
    end
end.parse!

if options[:machines].empty?
    $stderr.puts 'No LOMs selected.'
    exit 1
end

options[:machines].each do |h|
    case options[:action]
    when :jnlp
        Moob.start_jnlp options[:type], h, options
    end
end
